{% import "macros/head.html" as macros_head %}
{% import "macros/search.html" as macros_search %}
{% import "macros/header.html" as macros_header %}
{% import "macros/comments.html" as macros_comments %}
{% import "macros/toc.html" as macros_toc %}
{% import "macros/footer.html" as macros_footer %}
{% import "macros/sidebar.html" as macros_sidebar %}

<!DOCTYPE html>
<html lang="{{ lang | default(value='en') }}">
<head>
    {% if page is defined %}
        {{ macros_head::head(config=config, page=page, section=false, current_url=config.base_url) }}
    {% elif section is defined %}
        {{ macros_head::head(config=config, page=false, section=section, current_url=config.base_url) }}
    {% endif %}
    {% block extra_head %}{% endblock extra_head %}
</head>
<body>
    {{ macros_search::search(config=config) }}

    <div class="drawer lg:drawer-open">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col pt-16">
            {{ macros_header::header(config=config, lang=lang) }}

            {% set lang_root_path = "/" ~ lang ~ "/" %}
            {% if section is defined and (section.path == "/" or section.path == lang_root_path) and not config.extra.disable_root_sidebar_hide %}
            <div class="w-full">
                <main class="prose w-full mx-auto">
            {% else %}
            <div class="p-8 w-full max-w-7xl mx-auto lg:grid lg:grid-cols-[1fr_250px] lg:gap-8">
                <main class="prose w-full max-w-7xl mx-auto">
            {% endif %}
                    {% block content %}{% endblock content %}

                    {{ macros_comments::comments(config=config) }}

                    <nav class="mt-12 pt-8 border-t border-gray-500/15">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="prev-nav-item">
                                {% block prev_link %}{% endblock prev_link %}
                            </div>
                            <div class="next-nav-item">
                                {% block next_link %}{% endblock next_link %}
                            </div>
                        </div>
                    </nav>
                </main>

                {% if page is defined %}
                    {{ macros_toc::toc(page=page) }}
                {% endif %}
                {% if section is defined %}
                    {{ macros_toc::toc(page=section) }}
                {% endif %}
            </div>

            <script>
              // Determine theme: localStorage > extra.default_colorset > goyo-dark
              // Expose theme config for global use (e.g., goyo.js)
              window.defaultColorset = "{{ config.extra.default_colorset | default(value='dark') }}";
              window.themeMap = { "dark": "goyo-dark", "light": "goyo-light" };
              window.fallbackTheme = window.themeMap[window.defaultColorset] || "goyo-dark";
              
              // Theme mapping - maps user-friendly names to actual DaisyUI theme names
              var themeMapping = { "goyo-dark": "night", "goyo-light": "lofi" };
              var currentUserTheme = localStorage.getItem('theme') || window.fallbackTheme;
              var actualTheme = themeMapping[currentUserTheme] || currentUserTheme;
              
              var mermaidTheme = "dark";
              if(currentUserTheme == "goyo-light") {
                mermaidTheme = "light";
              }
              mermaid.initialize({ startOnLoad: false, theme: mermaidTheme });
              document.addEventListener('DOMContentLoaded', async () => {
                const mermaidElements = document.querySelectorAll('.mermaid');

                if (mermaidElements.length > 0) {
                    await mermaid.run({
                        nodes: mermaidElements
                    });
                }
              });
            </script>

        </div>

        {% set lang_root_path = "/" ~ lang ~ "/" %}
        {% if section is defined and (section.path == "/" or section.path == lang_root_path) and not config.extra.disable_root_sidebar_hide %}
        <div id="sidebar" class="hidden">
        {% else %}
        <div id="sidebar" class="drawer-side fixed top-0 pt-12 bottom-0 z-40 border-r border-gray-500/15">
        {% endif %}
            {% if section is defined %}
                {{ macros_sidebar::sidebar(config=config, lang=lang, current_path=current_path, section=section) }}
            {% else %}
                {{ macros_sidebar::sidebar(config=config, lang=lang, current_path=current_path, section=false) }}
            {% endif %}
        </div>
    </div>

    {% block js_body %}
        {% if config.build_search_index %}
        <script type="text/javascript" src="{{ get_url(path='fuse.min.js') | safe }}"></script>
        <script type="text/javascript" src="{{ get_url(path='search_index.' ~ lang ~ '.js') | safe }}"></script>
        {% endif %}
        <script type="text/javascript" src="{{ get_url(path='goyo.js') | safe }}"></script>
    {% endblock js_body %}
</body>
</html>
